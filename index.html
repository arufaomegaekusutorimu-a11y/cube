<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>CUBE</title>
    <style>
        /* --- ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼UIãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        body {
            margin: 0;
            background: radial-gradient(circle at center, #2c3e50 0%, #000 100%);
            font-family: 'Georgia', serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            color: #f1c40f;
        }

        /* --- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆãƒ˜ãƒƒãƒ€ãƒ¼ã¨ã—ã¦ç‹¬ç«‹ï¼‰ --- */
        #nav-header {
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 2px solid #f1c40f;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            flex-shrink: 0;
        }

        #nav-menu {
            display: flex;
            gap: 15px;
        }

        .nav-btn {
            background: rgba(26, 26, 26, 0.7);
            border: 1px solid #f1c40f;
            color: #f1c40f;
            padding: 8px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: 0.3s;
            font-weight: bold;
        }

        .nav-btn:hover:not(:disabled) {
            background: #f1c40f;
            color: #000;
            box-shadow: 0 0 10px #f1c40f;
        }

        /* å¼·åŒ–ãƒœã‚¿ãƒ³ãŒæŠ¼ã›ãªã„æ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .nav-btn:disabled {
            background: #1a1a1a;
            color: #444;
            border-color: #444;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* --- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å…±é€š --- */
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 800px; /* å›³é‘‘ç”¨ã«å°‘ã—åºƒã */
            max-height: 85vh;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            border: 3px double #f1c40f;
            border-radius: 15px;
            z-index: 3000;
            padding: 25px;
            overflow-y: auto;
            color: #fff;
            box-shadow: 0 0 50px rgba(0,0,0,0.9), inset 0 0 20px rgba(241, 196, 15, 0.2);
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹è¨­å®š */
            -ms-overflow-style: none; /* IE, Edge */
            scrollbar-width: none;    /* Firefox */
        }

        /* Webkitç”¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼éè¡¨ç¤ºè¨­å®š */
        .modal::-webkit-scrollbar {
            display: none;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #f1c40f;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.8em;
            text-shadow: 2px 2px 4px #000;
            letter-spacing: 3px;
        }

        .close-btn {
            cursor: pointer;
            font-size: 28px;
            color: #f1c40f;
            transition: 0.3s;
        }
        .close-btn:hover { transform: rotate(90deg); color: #fff; }

        /* --- å›³é‘‘UIã®åˆ·æ–° --- */
        #encyclopedia-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            padding: 10px;
        }

        .encyclopedia-item {
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
            cursor: default;
            overflow: hidden;
            min-height: 200px;
        }

        .encyclopedia-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #f1c40f;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
        }

        .encyclopedia-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            filter: drop-shadow(0 0 5px rgba(241, 196, 15, 0.5));
            transition: 0.5s;
        }

        .encyclopedia-img.locked {
            filter: brightness(0) invert(0.2) blur(2px);
            opacity: 0.5;
        }

        .encyclopedia-name {
            font-weight: bold;
            color: #f1c40f;
            font-size: 0.9em;
            margin-bottom: 5px;
            height: 2.4em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .encyclopedia-rarity {
            font-size: 0.7em;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(0,0,0,0.5);
            margin-bottom: 8px;
            border: 1px solid;
        }

        .encyclopedia-desc {
            font-size: 0.7em;
            color: #ccc;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-top: auto;
        }

        .encyclopedia-max-lv {
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 0.65em;
            color: #00ffcc;
            font-weight: bold;
        }

        /* å›³é‘‘ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ãƒãƒƒã‚¸ç”¨ */
        .shiny-found-badge {
            position: absolute;
            top: 5px;
            left: 5px;
            background: linear-gradient(45deg, #f1c40f, #fff);
            color: #000;
            font-size: 0.6em;
            font-weight: bold;
            padding: 2px 5px;
            border-radius: 3px;
            box-shadow: 0 0 5px #f1c40f;
            border: 1px solid #000;
        }

        /* --- è¨­å®šã‚¹ã‚¿ã‚¤ãƒ« --- */
        .setting-row { margin: 20px 0; display: flex; align-items: center; gap: 20px; }
        .danger-btn { background: #e74c3c; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; }

        /* ã‚·ãƒ§ãƒƒãƒ—ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .shop-upgrade-section {
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid #f1c40f;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .level-selector {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
        }

        .selector-btn {
            background: #1a1a1a;
            border: 1px solid #f1c40f;
            color: #f1c40f;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .selector-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .selector-btn:hover:not(:disabled) { background: #f1c40f; color: #000; }

        /* --- æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #mana-counter {
            font-size: 24px;
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
            background: rgba(0,0,0,0.5);
            padding: 5px 15px;
            border-radius: 20px;
            border: 1px solid #00ffcc;
            display: flex;
            min-width: 80px;
            transition: all 0.3s ease;
            cursor: help;
        }

        .mana-label { text-align: left; }
        .mana-value {
            flex-grow: 1;
            text-align: right;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-left: 0;
        }

        #mana-counter:hover { min-width: 200px; }
        #mana-counter:hover .mana-value { opacity: 1; width: auto; margin-left: 10px; }

        #status-tooltip {
            position: fixed;
            display: none;
            background: rgba(0, 0, 0, 0.9);
            border: 1px solid #f1c40f;
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            pointer-events: none;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.4);
            line-height: 1.4;
        }

        h2 {
            margin: 15px 20px;
            color: #f1c40f;
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            font-variant: small-caps;
            letter-spacing: 2px;
            border-bottom: 2px solid #f1c40f;
            display: inline-block;
            width: fit-content;
        }

        #main-content {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #shop-area {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            padding: 25px;
            display: flex;
            justify-content: center;
            gap: 20px;
            border-bottom: 3px double #f1c40f;
            flex-wrap: wrap;
        }

        .shop-slot {
            width: 100px;
            height: 140px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #444;
        }

        .buy-box {
            width: 70px;
            height: 70px;
            cursor: pointer;
            transition: all 0.3s ease;
            filter: drop-shadow(0 0 5px #f1c40f);
        }

        .buy-box:hover:not(.sold-out-img) {
            transform: translateY(-8px) scale(1.1);
            filter: drop-shadow(0 0 15px #f1c40f);
        }

        .sold-out-img { filter: grayscale(1) opacity(0.2) !important; cursor: not-allowed; }

        .buy-button {
            background: linear-gradient(135deg, #d4af37 0%, #f1c40f 50%, #d4af37 100%);
            color: #1a1a1a;
            border: 1px solid #000;
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: 0.2s;
        }

        .buy-button:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 10px #f1c40f; }
        .buy-button:disabled { opacity: 0.4; filter: grayscale(0.8); cursor: not-allowed; box-shadow: none; }

        #collection-area, #deck-area {
            padding: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            background-color: transparent;
            align-content: flex-start;
            justify-content: center;
        }

        #collection-area { flex-grow: 1; overflow-y: auto; }
        #deck-area { background: rgba(0, 255, 204, 0.03); border-top: 1px solid rgba(0, 255, 204, 0.2); padding-bottom: 30px; }

        .collected-item {
            width: 110px;
            height: 110px;
            border: 2px solid rgba(241, 196, 15, 0.2);
            background: rgba(255, 255, 255, 0.02);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 15px;
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .has-item { border: 2px solid #f1c40f; background: rgba(241, 196, 15, 0.05); cursor: grab; }
        .has-item:active { cursor: grabbing; }
        .dragging { opacity: 0.5; transform: scale(0.8); }
        .item-img { max-width: 65%; max-height: 65%; display: none; filter: drop-shadow(0 0 8px rgba(255,255,255,0.5)); pointer-events: none; }
        .level-badge { font-size: 12px; color: #fff; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 10px; font-weight: bold; margin-top: 5px; display: none; pointer-events: none; }
        .opened { border-color: #00ffcc; background: radial-gradient(circle, rgba(0,255,204,0.1) 0%, transparent 70%); box-shadow: 0 0 20px rgba(0,255,204,0.3); }

        /* ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ï¼ˆè‰²é•ã„ï¼‰ç”¨ã®è¿½åŠ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .is-shiny {
            box-shadow: 0 0 15px #fff, inset 0 0 10px #fff !important;
            border-color: #fff !important;
        }
        .is-shiny .item-img {
            filter: drop-shadow(0 0 12px #fff) hue-rotate(180deg) !important;
        }

        .rarity-S {
            background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd1de8, #dd1de8);
            background-size: 1800% 1800%;
            animation: rainbow 10s ease infinite;
            border-color: #fff !important;
        }
        @keyframes rainbow { 0%{background-position:0% 82%} 50%{background-position:100% 19%} 100%{background-position:0% 82%} }
        .rarity-A { background: rgba(255, 0, 0, 0.3) !important; border-color: #ff4d4d !important; }
        .rarity-B { background: rgba(128, 0, 128, 0.3) !important; border-color: #e066ff !important; }
        .rarity-C { background: rgba(0, 128, 0, 0.3) !important; border-color: #66ff66 !important; }
        .rarity-D { background: rgba(100, 100, 100, 0.3) !important; border-color: #999 !important; }

        #mana-shrine {
            height: 80px;
            margin: 10px 20px 10px 20px;
            background: linear-gradient(0deg, rgba(0, 255, 204, 0.1), transparent);
            border: 2px dashed #00ffcc;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00ffcc;
            font-weight: bold;
            letter-spacing: 3px;
            transition: all 0.3s;
        }

        #mana-shrine.drag-over { background: rgba(0, 255, 204, 0.2); transform: scale(1.02); box-shadow: 0 0 20px rgba(0, 255, 204, 0.4); }

        #message-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(to right, transparent, rgba(0,0,0,0.9), transparent);
            color: #fff;
            text-shadow: 0 0 15px #00ffcc, 0 0 30px #00ffcc;
            width: 100%;
            text-align: center;
            padding: 25px 0;
            font-size: 2.5em;
            font-style: italic;
            letter-spacing: 5px;
            pointer-events: none;
            opacity: 0;
            transition: all 0.4s ease;
            z-index: 5000;
            border-top: 1px solid #00ffcc;
            border-bottom: 1px solid #00ffcc;
        }
    </style>
</head>
<body>

    <header id="nav-header">
        <nav id="nav-menu">
            <button class="nav-btn" onclick="openModal('modal-encyclopedia')">å›³é‘‘</button>
            <button class="nav-btn" onclick="openModal('modal-shop')">ã‚·ãƒ§ãƒƒãƒ—</button>
            <button class="nav-btn" onclick="openModal('modal-settings')">è¨­å®š</button>
        </nav>
        <div id="mana-counter">
            <span class="mana-label">Mana</span>
            <span id="mana-val" class="mana-value">0</span>
        </div>
    </header>

    <div id="main-content">
        <div id="status-tooltip"></div>
        <div id="message-overlay">å…¥æ‰‹ï¼ãƒŠãƒãƒ¥ãƒ©ãƒœãƒƒã‚¯ã‚¹</div>

        <div id="modal-encyclopedia" class="modal">
            <div class="modal-header">
                <h3>ğŸ“œ ä½¿ã„é­”å¤æ–‡æ›¸</h3>
                <span class="close-btn" onclick="closeModal('modal-encyclopedia')">&times;</span>
            </div>
            <div id="encyclopedia-list"></div>
        </div>

        <div id="modal-shop" class="modal">
            <div class="modal-header">
                <h3>é­”æ³•ã®é“å…·å±‹ãƒ»å¼·åŒ–ç¥­å£‡</h3>
                <span class="close-btn" onclick="closeModal('modal-shop')">&times;</span>
            </div>
            <div id="shop-upgrade-ui">
                </div>
            <hr>
            <p style="font-size: 0.9em; opacity: 0.8;">â€»ã‚­ãƒ¥ãƒ¼ãƒ–ã‚’å¼·åŒ–ã™ã‚‹ã¨ã€æ’å‡ºã•ã‚Œã‚‹ä½¿ã„é­”ã®è³ªãŒå‘ä¸Šã—ã€è²©å£²ä¾¡æ ¼ãŒä¸Šæ˜‡ã—ã¾ã™ã€‚</p>
        </div>

        <div id="modal-settings" class="modal">
            <div class="modal-header">
                <h3>å„€å¼ã®èª¿æ•´</h3>
                <span class="close-btn" onclick="closeModal('modal-settings')">&times;</span>
            </div>
            <div class="setting-row">
                <label>BGM Volume</label>
                <input type="range" id="bgm-vol" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume()">
            </div>
            <div class="setting-row">
                <label>SE Volume</label>
                <input type="range" id="se-vol" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume()">
            </div>
            <hr>
            <div class="setting-row">
                <button class="danger-btn" onclick="resetData()">è¨˜æ†¶ã®æ¶ˆå»ï¼ˆãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ï¼‰</button>
            </div>
        </div>

        <h2>â—† ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚­ãƒ¥ãƒ¼ãƒ– <span id="refresh-timer" style="font-size: 0.6em; opacity: 0.8; margin-left: 10px; color: #00ffcc;"></span></h2>
        <div id="shop-area"></div>

        <h2>â—† åˆæˆã‚¹ãƒ­ãƒƒãƒˆ</h2>
        <div id="collection-area"></div>

        <h2>â—† ãƒãƒŠãƒãƒ£ãƒ¼ã‚¸ã‚¹ãƒ­ãƒƒãƒˆ</h2>
        <div id="deck-area"></div>

        <div id="mana-shrine">ã“ã“ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãƒãƒŠã¸å¤‰æ›ï¼ˆå£²å´ï¼‰</div>
    </div>

<script>
    const shopArea = document.getElementById('shop-area');
    const collectionArea = document.getElementById('collection-area');
    const deckArea = document.getElementById('deck-area');
    const manaShrine = document.getElementById('mana-shrine');
    const messageOverlay = document.getElementById('message-overlay');
    const refreshTimer = document.getElementById('refresh-timer');
    const manaValDisplay = document.getElementById('mana-val');
    const tooltip = document.getElementById('status-tooltip');
    
    const MAX_STORAGE = 10;
    const MAX_DECK = 5;
    const REFRESH_INTERVAL = 30;

    const CHAR_DATA = {
        'oni.png': { name: 'ç¾…åˆ¹ã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'S', incomeMult: 1.2, desc: 'å¤ã®æˆ¦å ´ã§æ•£ã£ãŸé¬¼ã®é­‚ãŒå…·ç¾åŒ–ã—ãŸå§¿ã€‚ãã®åˆƒã¯ç©ºé–“ã‚’ã‚‚åˆ‡ã‚Šè£‚ãã€å‘¨å›²ã®ãƒãƒŠã‚’å¼·åˆ¶çš„ã«åæŸã•ã›ã‚‹åŠ›ã‚’æŒã¤ã€‚æ¥µã‚ã¦é«˜ã„é­”åŠ›ä¾›çµ¦ç‡ã‚’èª‡ã‚‹ä¼èª¬ã®å­˜åœ¨ã€‚' },
        'demon.png': { name: 'ç„ç‚ã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'S', incomeMult: 1.0, desc: 'åœ°ç„ã®æœ€ä¸‹å±¤ã‹ã‚‰å¬å–šã•ã‚ŒãŸä¸Šä½æ‚ªé­”ã€‚å¸¸ã«å‘¨å›²ã‚’ç„¼ãå°½ãã™ã»ã©ã®ç†±é‡ã‚’æ”¾ã¡ã€è² ã®æ„Ÿæƒ…ã‚’ç´”ç²‹ãªé­”åŠ›ã¸ã¨å¤‰æ›ã™ã‚‹ã€‚ãã®åŠ›ã¯å‡è¡¡ã‚’å´©ã™ã»ã©ã«å¼·å¤§ã§ã‚ã‚‹ã€‚' },
        'clock.png': { name: 'ã‚¯ãƒ­ãƒƒã‚¯ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'S', incomeMult: 0.8, desc: 'æ™‚ç©ºã®ç‹­é–“ã«ä½ã¾ã†è¬å¤šãå­˜åœ¨ã€‚ç ‚æ™‚è¨ˆãŒåˆ»ã‚€ãƒªã‚ºãƒ ã«åˆã‚ã›ã¦å®‡å®™ã®æ³•å‰‡ã‚’æ›¸ãæ›ãˆã€åŠ¹ç‡çš„ã«ãƒãƒŠã‚’æŠ½å‡ºã™ã‚‹ã€‚å½¼ã®å‰ã§ã¯æ™‚é–“ã™ã‚‰ã‚‚ãŸã ã®æ¦‚å¿µã«éããªã„ã€‚' },
        'frost.png': { name: 'ãƒ•ãƒ­ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'S', incomeMult: 1.2, desc: 'å…¨ã¦ã‚’é™æ­¢ã•ã›ã‚‹çµ¶å¯¾é›¶åº¦ã®é­”åŠ›ã‚’æŒã¤ã€‚å½¼ã®å‘¨å›²ã§ã¯ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼ãŒæ¸›å°‘ã—ã€ç´”ç²‹ãªé­”åŠ›ãŒç„¡é™ã«ç”Ÿæˆã•ã‚Œã‚‹ã€‚' },
        'eternal.png': { name: 'æ°¸åŠ«ã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'S', incomeMult: 1.1, desc: 'çµ‚ã‚ã‚Šã®ãªã„æ™‚é–“ã‚’å¸ã‚‹ç¥ç§˜ of ã®å­˜åœ¨ã€‚éå»ã¨æœªæ¥ã‹ã‚‰ãƒãƒŠã‚’å¸ã„å¯„ã›ã€ç¾åœ¨ã«å®šç€ã•ã›ã‚‹ã€‚' },
        'ice.png': { name: 'æ°·çµã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 1.15, desc: 'æ°¸ä¹…å‡åœŸã®å¥¥æ·±ãã«çœ ã£ã¦ã„ãŸç²¾éœŠã€‚å½¼å¥³ãŒé€šã‚‹é“ã¯ä¸€ç¬ã§æ°·ã«é–‰ã–ã•ã‚Œã€é™å¯‚ã®ä¸­ã«é«˜å¯†åº¦ã®é­”åŠ›ãŒçµæ™¶åŒ–ã™ã‚‹ã€‚å†·å¾¹ã ãŒå¥‘ç´„è€…ã«ã¯å¿ å®Ÿãªå®ˆè­·è€…ã¨ãªã‚‹ã€‚' },
        'rip.png': { name: 'æ–­ç½ªã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 0.9, desc: 'å‘½ã®ç¯ç«ã‚’åˆˆã‚Šå–ã‚‹æ­»ç¥ã®ä»£è¡Œè€…ã€‚é­‚ã‚’åˆˆã‚Šå–ã‚‹éš›ã«ç”Ÿã˜ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’ãƒãƒŠã¨ã—ã¦ç²¾è£½ã™ã‚‹ã€‚ä¸æ°—å‘³ãªå¤–è¦‹ã«åã—ã¦ã€é­”åŠ›ã®ç²¾è£½ãƒ—ãƒ­ã‚»ã‚¹ã¯éå¸¸ã«åˆç†çš„ã§ç¾ã—ã„ã€‚' },
        'Necromancer.png': { name: 'æ­»éœŠè¡“ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 1.0, desc: 'æ­»ã®å¢ƒç•Œç·šã‚’æ“ã‚‹ç¦å¿Œã®é­”è¡“å¸«ã€‚æ»…ã³ãŸé­‚ã‚’å†æ§‹æˆã—ã€å¼·åŠ›ãªãƒãƒŠã®ä¾›çµ¦æºã¨ã—ã¦ä½¿å½¹ã™ã‚‹ã€‚' },
        'angel.png': { name: 'è–åŸŸã®å®ˆè­·ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 1.1, desc: 'å¤©ç•Œã‚ˆã‚Šé£ã‚ã•ã‚ŒãŸæ…ˆæ„›ã®è±¡å¾´. ãã®ç¾½ã‹ã‚‰æ”¾ãŸã‚Œã‚‹è¼ãã¯å‘¨å›²ã‚’æµ„åŒ–ã—ã€è–ãªã‚‹ãƒãƒŠã‚’æº¢ã‚Œã•ã›ã‚‹ã€‚' },
        'cyber-.png': { name: 'ã‚µã‚¤ãƒãƒ¼ãƒ»ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 1.1, desc: 'é›»è„³ä¸–ç•Œã‹ã‚‰ç¾ã‚ŒãŸãƒ‡ã‚¸ã‚¿ãƒ«ç”Ÿå‘½ä½“ã€‚å›è·¯ã‚’æµã‚Œã‚‹é›»å­ã‚’é­”åŠ›ã¸å¤‰æ›ã—ã€é©šç•°çš„ãªæƒ…å ±å‡¦ç†èƒ½åŠ›ã§åŸºåœ°ã‚’æœ€é©åŒ–ã™ã‚‹ã€‚' },
        'magma.png': { name: 'ãƒã‚°ãƒãƒ»ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 1.05, desc: 'æ´»ç«å±±ã®æ·±å±¤ã§ç·´ã‚Šä¸Šã’ã‚‰ã‚ŒãŸå²©çŸ³ã®å·¨äººã€‚ä½“å†…ã«æµã‚Œã‚‹æº¶å²©ã¯ç„¡å°½è”µã®ç†±ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ”¾ã¡ã€å‘¨å›²ã®é­”åŠ›ã‚’æ´»æ€§åŒ–ã•ã›ã‚‹ã€‚' },
        'samurai.png': { name: 'ç‚ä¾ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 1.1, desc: 'ç•°å›½ã®åœ°ã‹ã‚‰ã‚„ã£ã¦ããŸå‰£ã®é”äººã€‚ç ”ãæ¾„ã¾ã•ã‚ŒãŸé›†ä¸­åŠ›ã¯ãƒãƒŠã®ä¹±ã‚Œã‚’æ–¬ã‚Šä¼ã›ã€ç´”åº¦ã®é«˜ã„é­”åŠ›å¾ªç’°ã‚’ç”Ÿã¿å‡ºã™ã€‚' },
        'Shinobi.png': { name: 'é—‡å¿ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'A', incomeMult: 1.2, desc: 'å§¿ã‚’è¦‹ã›ãšä»»å‹™ã‚’é‚è¡Œã™ã‚‹å½±ã®å·¥ä½œå“¡ã€‚éš å¯†å›è·¯ã‚’é§†ä½¿ã—ã¦è™šç©ºã‹ã‚‰å¾®ç´°ãªé­”åŠ›ã‚’åŠ¹ç‡ã‚ˆãåé›†ã—ã€ä¸»ã¸ã¨æ§ã’ã‚‹ã€‚' },
        'treasure.png': { name: 'ã‚´ãƒ¼ã‚¹ãƒˆã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 1.1, desc: 'å¼·æ¬²ãªç‹ã®åŸ·å¿µãŒé‡‘è²¨ã«å®¿ã£ãŸå§¿ã€‚ç‰©è³ªçš„ãªå¯Œã‚’éœŠçš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã¸å¤‰æ›ã™ã‚‹ç‰¹ç•°ãªä½“è³ªã‚’æŒã¤ã€‚æˆä»ã§ããªã„æ‚²ã—ã¿ã•ãˆã‚‚ã€ä»Šã¯åŸºåœ°ã®è²´é‡ãªå‹•åŠ›æºã¨ãªã£ã¦ã„ã‚‹ã€‚' },
        'sweet.png': { name: 'ç”˜ç¾ãªã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 1.0, desc: 'äººã€…ã®æ¬²æœ›ã‚’ç³§ã«ã™ã‚‹å¤¢é­”ã®çœ·å±ã€‚ç”˜ã„é¦™ã‚Šã§ãƒãƒŠã®éœ§ã‚’å¼•ãå¯„ã›ã€è‡ªã‚‰ã®ç³§ã¨ã™ã‚‹ã€‚æ”»æ’ƒåŠ›ã¯ä½ã„ãŒã€å®‰å®šã—ãŸé­”åŠ›ä¾›çµ¦ã‚’å¾—æ„ã¨ã™ã‚‹ãŸã‚ã€ä½¿ã„å‹æ‰‹ãŒéå¸¸ã«è‰¯ã„ã€‚' },
        'night.png': { name: 'å¸¸é—‡ã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 0.85, desc: 'å½±ã®ä¸­ã«æ½œã‚€ã“ã¨ã‚’è¨±ã•ã‚ŒãŸæ¼†é»’ã®é§ã€‚ä¸»äººã®å‘½ã«å¾“ã„ã€æš—é—‡ã«æ¼‚ã†å¾®ç´°ãªé­”åŠ›ã‚’ç›¾ã«é›†ã‚ã¦åœ§ç¸®ã™ã‚‹ã€‚åœ°å‘³ãªãŒã‚‰ã‚‚å …å®Ÿãªåƒãã‚’è¦‹ã›ã‚‹ã€ä¿¡é ¼ã®ç½®ã‘ã‚‹ä½¿ã„é­”ã€‚' },
        'pirate.png': { name: 'å¹½éœŠèˆ¹ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 0.95, desc: 'è’ã‚Œç‹‚ã†æµ·ã§æ¶ˆãˆãŸæµ·è³Šã®é­‚ã€‚ç•¥å¥ªã®æœ¬èƒ½ã¯æ¶ˆãˆã¦ãŠã‚‰ãšã€è™šç©ºã‹ã‚‰ãƒãƒŠã‚’ã‹ãé›†ã‚ã¦ãã‚‹ã€‚' },
        'punk.png': { name: 'å›é€†ã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 1.0, desc: 'ç§©åºã‚’å«Œã†ãƒ‘ãƒ³ã‚¯ãƒ­ãƒƒã‚«ãƒ¼ã®é­‚ã€‚æ¿€ã—ã„ãƒ“ãƒ¼ãƒˆã«ä¹—ã›ã¦ãƒãƒŠã‚’æ¿€å‹•ã•ã›ã€ç¬é–“çš„ãªå‡ºåŠ›ã‚’é«˜ã‚ã‚‹ã€‚' },
        'steam.png': { name: 'è’¸æ°—ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 1.05, desc: 'æ­¯è»Šã¨è’¸æ°—ã‚’æ„›ã™ã‚‹ç•°ä¸–ç•Œã®æŠ€è¡“è€…ã€‚é­”åŠ›å›è·¯ã‚’æ©Ÿæ¢°çš„ã«æœ€é©åŒ–ã—ã€å®‰å®šã—ãŸãƒãƒŠã®æµã‚Œã‚’ä½œã‚Šå‡ºã™ã€‚' },
        'joker.png': { name: 'é“åŒ–å¸«ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 0.9, desc: 'äºˆæ¸¬ä¸èƒ½ãªè¡Œå‹•ã§å‘¨å›²ã‚’ç¿»å¼„ã™ã‚‹å¥‡è¡“å¸«ã€‚ãƒãƒŠã®æ³•å‰‡ã‚’æ›¸ãæ›ãˆã€äºˆæƒ³å¤–ã®å¢—å¹…ã‚’å¼•ãèµ·ã“ã™ã€‚' },
        'psycho.png': { name: 'è™šç„¡ã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 1.1, desc: 'å£Šã‚ŒãŸå¿ƒãŒç”Ÿã¿å‡ºã™ç•°è³ªãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã€‚ãã®åˆ¶å¾¡ä¸èƒ½ãªåŠ›ã¯ã€æ™‚ã¨ã—ã¦çˆ†ç™ºçš„ãªãƒãƒŠã‚’ç”Ÿã‚€ã€‚' },
        'witch.png': { name: 'æ·±æ·µã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'B', incomeMult: 1.0, desc: 'å¤±ã‚ã‚ŒãŸç§˜è¡“ã‚’ç¶™æ‰¿ã™ã‚‹é­”å¥³ã€‚å¤ã®å¥‘ç´„ã«åŸºã¥ãã€è‡ªç„¶ç•Œã‹ã‚‰ãƒãƒŠã‚’åŠ¹ç‡ã‚ˆãæŠ½å‡ºã™ã‚‹ã€‚' },
        'nature.png': { name: 'ç²¾éœŠã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'C', incomeMult: 1.1, desc: 'å¤§è‡ªç„¶ã®æ¯å¹ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸä¸‹ç´šç²¾éœŠã€‚å¤ªé™½ã®å…‰ã¨å¤§åœ°ã®æµã¿ã‚’å‘¼å¸ã®ã‚ˆã†ã«ãƒãƒŠã¸ã¨å¤‰ãˆã‚‹ã€‚å€‹ã€…ã®åŠ›ã¯å¼±ã„ãŒã€è‡ªç„¶ç•Œã®èª¿å’Œã‚’ä¿ã¤ãŸã‚ã«ã¯æ¬ ã‹ã›ãªã„å­˜åœ¨ã€‚' },
        'mash.png': { name: 'ã‚­ãƒã‚³ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'C', incomeMult: 0.9, desc: 'ä½•ç™¾å¹´ã‚‚ç”Ÿãå»¶ã³ãŸé­”æ³•ã‚­ãƒã‚³ã€‚èƒå­ã‚’æ’’ãæ•£ã‚‰ã—ã¦å‘¨å›²ã®é­”åŠ›å¯†åº¦ã‚’å¾®å¢—ã•ã›ã‚‹ã€‚ã®ã‚“ã³ã‚Šã—ãŸæ€§æ ¼ã ãŒã€ãã®çŸ¥è­˜ã¯æ·±ãã€ç¨€ã«æœ‰ç›ŠãªãƒãƒŠã®å¾ªç’°ã‚’åŠ©ã‘ã‚‹ã€‚' },
        'honey.png': { name: 'ãƒãƒãƒŸãƒ„ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'C', incomeMult: 1.0, desc: 'ç”˜ã„èœœã‚’é‹ã¶å°ã•ãªå¦–ç²¾ã€‚ãƒãƒŠã‚’èœœã®ã‚ˆã†ã«å‡ç¸®ã—ã€è²¯è”µã™ã‚‹èƒ½åŠ›ã‚’æŒã¤ã€‚' },
        'cactus.png': { name: 'ãƒˆã‚²ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'C', incomeMult: 0.85, desc: 'ä¹¾ç‡¥åœ°å¸¯ã§ç”ŸãæŠœãã‚¿ãƒ•ãªæ¤ç‰©ã€‚éé…·ãªç’°å¢ƒã§ã‚‚å¾®é‡ãªãƒãƒŠã‚’å¸åã—ã€ä½“å†…ã«è“„ãˆç¶šã‘ã‚‹ã€‚' },
        'mummy.png': { name: 'ãƒŸã‚¤ãƒ©ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'C', incomeMult: 0.9, desc: 'å‘ªã„ã®åŒ…å¸¯ã‚’å·»ã„ãŸä¸æ­»è€…ã€‚æ°¸ã„çœ ã‚Šã®ä¸­ã§æºœã‚è¾¼ã‚“ã å¤ã®ãƒãƒŠã‚’å°‘ã—ãšã¤æ”¾å‡ºã™ã‚‹ã€‚' },
        'water.png': { name: 'ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'C', incomeMult: 1.0, desc: 'æ¸…ã‚‰ã‹ãªæ°´ã‹ã‚‰ç”Ÿã¾ã‚ŒãŸç²¾éœŠã€‚æ·€ã‚“ã ãƒãƒŠã‚’æ´—ã„æµã—ã€å¾ªç’°ã‚’ã‚¹ãƒ ãƒ¼ã‚ºã«ã™ã‚‹ã€‚' },
        'fire.png': { name: 'ç¯ç«ã®ã‚­ãƒ¥ãƒ¼ãƒ–', rarity: 'C', incomeMult: 1.0, desc: 'æ¶ˆãˆãã†ã§æ¶ˆãˆãªã„ä¸æ€è­°ãªç«ã€‚å‘¨å›²ã®ãƒãƒŠã‚’ç‡ƒç„¼ã•ã›ã€ç´”ç²‹ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã¸ã¨å¤‰æ›ã™ã‚‹ã€‚' },
        'hero.png': { name: 'Hero', rarity: 'D', incomeMult: 1.0, desc: 'ç•°ä¸–ç•Œã‹ã‚‰è¿·ã„è¾¼ã‚“ã ä¼èª¬ã®å‹‡è€…ã€‚ãƒ¬ãƒ™ãƒ«ã¨ã„ã†æ¦‚å¿µã‚’è¶…è¶Šã—ã¦ãŠã‚Šã€å¸¸ã«ä¸€å®šã®ãƒãƒŠï¼ˆ1000/secï¼‰ã‚’ä¾›çµ¦ã™ã‚‹ã€‚åˆæˆã¯ã§ããªã„ãŒã€å®‰å®šæ„Ÿã¯æŠœç¾¤ã€‚' }
    };

    let currentItemCount = 0;
    let draggedElement = null;
    
    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    let savedData = JSON.parse(localStorage.getItem('natura_base_save')) || {};
    let totalMana = savedData.mana || 10000;
    let unlockedChars = savedData.unlocked || [];
    let unlockedShinies = savedData.unlockedShinies || []; // ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ç™ºè¦‹è¨˜éŒ²ç”¨
    let maxLevels = savedData.maxLevels || {}; // æœ€é«˜ãƒ¬ãƒ™ãƒ«è¨˜éŒ²ç”¨
    let timeLeft = savedData.shopTime !== undefined ? savedData.shopTime : REFRESH_INTERVAL;
    let boxLevel = savedData.boxLevel || 1; 
    let maxUnlockedBoxLevel = savedData.maxUnlockedBoxLevel || 1; // è§£æ”¾æ¸ˆã¿ã®æœ€é«˜ãƒœãƒƒã‚¯ã‚¹ãƒ¬ãƒ™ãƒ«
    let shopInventory = savedData.shopInventory || null; // ã‚·ãƒ§ãƒƒãƒ—ã®å£²ã‚Šåˆ‡ã‚ŒçŠ¶æ…‹

    const bgm = new Audio('bgm.mp3');
    bgm.loop = true;
    const seShopRefresh = new Audio('shop.mp3');
    const seCombine = new Audio('re.mp3');
    const seCash = new Audio('cash.mp3');
    const seBox = new Audio('box.mp3');
    const seSell = new Audio('sell.mp3');

    // ãƒœãƒªãƒ¥ãƒ¼ãƒ åˆæœŸåŒ–
    bgm.volume = savedData.bgmVol !== undefined ? savedData.bgmVol : 0.5;
    [seShopRefresh, seCombine, seCash, seBox, seSell].forEach(s => s.volume = savedData.seVol !== undefined ? savedData.seVol : 0.5);

    function saveData() {
        const collectionSlots = Array.from(document.querySelectorAll('#collection-area .collected-item')).map(s => getSlotState(s));
        const deckSlots = Array.from(document.querySelectorAll('#deck-area .collected-item')).map(s => getSlotState(s));
        
        // ã‚·ãƒ§ãƒƒãƒ—ã®åœ¨åº«çŠ¶æ³ï¼ˆå£²ã‚Šåˆ‡ã‚Œã‹ã©ã†ã‹ï¼‰ã‚’å–å¾—
        const shopSlots = Array.from(document.querySelectorAll('.buy-button')).map(btn => btn.innerText === 'å¥‘ç´„æ¸ˆã¿');

        const data = {
            mana: totalMana,
            unlocked: unlockedChars,
            unlockedShinies: unlockedShinies, // ä¿å­˜
            maxLevels: maxLevels, 
            bgmVol: bgm.volume,
            seVol: seCombine.volume,
            collection: collectionSlots,
            deck: deckSlots,
            shopTime: timeLeft,
            boxLevel: boxLevel,
            maxUnlockedBoxLevel: maxUnlockedBoxLevel,
            shopInventory: shopSlots 
        };
        localStorage.setItem('natura_base_save', JSON.stringify(data));
    }

    function getSlotState(slot) {
        if (!slot.classList.contains('has-item')) return null;
        const img = slot.querySelector('.item-img');
        return {
            img: img ? img.src.split('/').pop() : null,
            level: slot.dataset.level,
            isSpecial: slot.dataset.isSpecial,
            opened: slot.classList.contains('opened')
        };
    }

    function loadGameProgress() {
        if (savedData.collection) {
            const slots = document.querySelectorAll('#collection-area .collected-item');
            savedData.collection.forEach((state, i) => { if(state) restoreSlot(slots[i], state); });
        }
        if (savedData.deck) {
            const slots = document.querySelectorAll('#deck-area .collected-item');
            savedData.deck.forEach((state, i) => { if(state) restoreSlot(slots[i], state); });
        }
        updateManaUI();
    }

    function restoreSlot(slot, state) {
        slot.classList.add('has-item');
        slot.draggable = true;
        slot.dataset.level = state.level;
        slot.dataset.isSpecial = state.isSpecial;
        
        const img = document.createElement('img');
        img.src = state.img;
        img.className = 'item-img';
        img.style.display = 'block';
        
        const badge = document.createElement('div');
        badge.className = 'level-badge';
        
        slot.appendChild(img);
        slot.appendChild(badge);
        
        if (state.opened) {
            const data = CHAR_DATA[state.img];
            if (data) slot.classList.add(`rarity-${data.rarity}`, 'opened');
            if (state.isSpecial === "true") slot.classList.add('is-shiny');
            updateLevelDisplay(slot);
        } else {
            slot.onclick = () => openAction(slot);
        }
        currentItemCount++;
    }

    function openModal(id) {
        // ã™ã¹ã¦ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸€æ—¦é–‰ã˜ã‚‹
        const modals = document.querySelectorAll('.modal');
        modals.forEach(modal => modal.style.display = 'none');

        if(id === 'modal-encyclopedia') updateEncyclopediaUI();
        if(id === 'modal-shop') updateShopUpgradeUI(); // ã‚·ãƒ§ãƒƒãƒ—UIã‚’æ›´æ–°
        document.getElementById(id).style.display = 'block';
    }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    // ã‚·ãƒ§ãƒƒãƒ—å†…ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰UIã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function updateShopUpgradeUI() {
        const container = document.getElementById('shop-upgrade-ui');
        let upgradePrices = {1: 5000000, 2: 50000000, 3: 500000000};
        let nextPrice = upgradePrices[maxUnlockedBoxLevel];
        
        let levelText = boxLevel === 4 ? "MAX" : boxLevel;

        let html = `
            <div class="shop-upgrade-section">
                <h4>ãƒœãƒƒã‚¯ã‚¹ãƒ¬ãƒ™ãƒ«èª¿æ•´</h4>
                <div class="level-selector">
                    <button class="selector-btn" onclick="changeBoxLevel(-1)" ${boxLevel <= 1 ? 'disabled' : ''}>&lt;</button>
                    <span style="color:#f1c40f; font-size:1.8em; font-weight:bold; width: 60px;">Lv.${levelText}</span>
                    <button class="selector-btn" onclick="changeBoxLevel(1)" ${boxLevel >= maxUnlockedBoxLevel ? 'disabled' : ''}>&gt;</button>
                </div>
                <p style="font-size: 0.8em; color: #aaa;">(è§£æ”¾æ¸ˆã¿ã®ãƒ¬ãƒ™ãƒ«ç¯„å›²å†…ã§è‡ªç”±ã«èª¿æ•´å¯èƒ½ã§ã™)</p>
        `;

        if (maxUnlockedBoxLevel < 4) {
            html += `
                <hr style="border: 0.5px solid rgba(241,196,15,0.3); margin: 20px 0;">
                <p>æ¬¡ã®ãƒ¬ãƒ™ãƒ«ã®è§£æ”¾è²»ç”¨: <span style="color:#00ffcc;">${formatMana(nextPrice)} Mana</span></p>
                <button class="nav-btn" id="upgrade-box-btn" onclick="upgradeBox(${nextPrice})" ${totalMana < nextPrice ? 'disabled' : ''}>
                    ä¸Šä½ãƒ¬ãƒ™ãƒ«ã‚’è§£æ”¾ã™ã‚‹ (Lv.${maxUnlockedBoxLevel} â†’ ${maxUnlockedBoxLevel + 1})
                </button>
            `;
        } else {
            html += `<p style="color:#00ffcc; margin-top:15px;">å…¨ã¦ã®ãƒ¬ãƒ™ãƒ«ãŒè§£æ”¾ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>`;
        }
        html += `</div>`;
        container.innerHTML = html;
    }

    function changeBoxLevel(diff) {
        const newLevel = boxLevel + diff;
        // è§£æ”¾æ¸ˆã¿ã®æœ€é«˜ãƒ¬ãƒ™ãƒ«ï¼ˆmaxUnlockedBoxLevelï¼‰ã‚’è¶…ãˆãªã„ç¯„å›²ã§è‡ªç”±ã«èª¿æ•´å¯èƒ½
        if (newLevel >= 1 && newLevel <= maxUnlockedBoxLevel) {
            boxLevel = newLevel;
            updateShopUpgradeUI();
            initShop();
            saveData();
            showGetMessage(`ã‚­ãƒ¥ãƒ¼ãƒ– Lv.${boxLevel} ã«èª¿æ•´ã—ã¾ã—ãŸ`);
        }
    }

    function upgradeBox(price) {
        if (totalMana < price) return;
        totalMana -= price;
        maxUnlockedBoxLevel++;
        boxLevel = maxUnlockedBoxLevel; // è§£æ”¾ã—ãŸã‚‰è‡ªå‹•ã§ãã®ãƒ¬ãƒ™ãƒ«ã«ã™ã‚‹
        playSound(seCash);
        showGetMessage(`æ–°ãƒ¬ãƒ™ãƒ«è§£æ”¾ï¼ Lv.${maxUnlockedBoxLevel}`);
        updateShopUpgradeUI();
        updateManaUI();
        initShop(); // ã‚·ãƒ§ãƒƒãƒ—ã®å•†å“ä¾¡æ ¼ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«å†èµ·å‹•
        saveData();
    }

    function updateVolume() {
        bgm.volume = document.getElementById('bgm-vol').value;
        const sv = document.getElementById('se-vol').value;
        [seShopRefresh, seCombine, seCash, seBox, seSell].forEach(s => s.volume = sv);
        saveData();
    }

    function resetData() {
        if(confirm("å…¨ã¦ã®è¨˜æ†¶ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿï¼ˆæœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã«ãªã‚Šã¾ã™ï¼‰")) {
            localStorage.removeItem('natura_base_save');
            location.reload();
        }
    }

    function updateEncyclopediaUI() {
        const list = document.getElementById('encyclopedia-list');
        list.innerHTML = '';
        
        // ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †ã«ä¸¦ã³æ›¿ãˆ
        const rarityOrder = { 'S': 0, 'A': 1, 'B': 2, 'C': 3, 'D': 4 };
        const sortedKeys = Object.keys(CHAR_DATA).sort((a, b) => {
            return rarityOrder[CHAR_DATA[a].rarity] - rarityOrder[CHAR_DATA[b].rarity];
        });

        sortedKeys.forEach(key => {
            const data = CHAR_DATA[key];
            const isUnlocked = unlockedChars.includes(key);
            const isShinyUnlocked = unlockedShinies.includes(key); // ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ç™ºè¦‹æ¸ˆã¿ã‹
            const mLevel = maxLevels[key] || 0;
            const item = document.createElement('div');
            item.className = 'encyclopedia-item';
            
            // è‰²åˆ†ã‘ç”¨ã®ã‚¯ãƒ©ã‚¹ã‚’é©ç”¨ï¼ˆè§£æ”¾æ™‚ã®ã¿ï¼‰
            if (isUnlocked) {
                item.style.borderColor = getRarityColor(data.rarity);
            }

            item.innerHTML = `
                ${isUnlocked && key !== 'hero.png' ? `<div class="encyclopedia-max-lv">MAX LV: ${mLevel}</div>` : ''}
                ${isShinyUnlocked ? `<div class="shiny-found-badge">â˜…Shiny Found!</div>` : ''}
                <img src="${key}" class="encyclopedia-img ${isUnlocked ? '' : 'locked'}">
                <div class="encyclopedia-rarity" style="color:${getRarityColor(data.rarity)}; border-color:${getRarityColor(data.rarity)}">
                    ${data.rarity} Class
                </div>
                <div class="encyclopedia-name">${isUnlocked ? data.name : 'ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ'}</div>
                <div class="encyclopedia-desc">${isUnlocked ? data.desc : 'æœªå¥‘ç´„ã®ã‚­ãƒ¥ãƒ¼ãƒ–ã§ã™ã€‚å¬å–šã—ã¦æƒ…å ±ã‚’é–‹ç¤ºã—ã¦ãã ã•ã„ã€‚'}</div>
            `;
            list.appendChild(item);
        });
    }

    function getRarityColor(rarity) {
        switch(rarity) {
            case 'S': return '#ff4500';
            case 'A': return '#ff4d4d';
            case 'B': return '#e066ff';
            case 'C': return '#66ff66';
            case 'D': return '#ffffff';
            default: return '#f1c40f';
        }
    }

    function playSound(sound) {
        sound.currentTime = 0;
        sound.play().catch(e => console.log("Audio play blocked"));
    }

    function startBGM() {
        bgm.play().catch(e => console.log("BGM play waiting"));
    }

    function formatMana(val) {
        if (val < 1000) return Math.floor(val);
        const units = ["", "k", "m", "g", "t", "p", "e", "z", "y"];
        const i = Math.floor(Math.log(val) / Math.log(1000));
        return (val / Math.pow(1000, i)).toFixed(2) + units[i];
    }

    function calculateIncome(slot) {
        if (!slot.classList.contains('opened')) return 0;
        const level = parseInt(slot.dataset.level);
        let base = 0;
        const imgPath = slot.querySelector('.item-img').src.split('/').pop();
        const data = CHAR_DATA[imgPath];
        if (!data) return 0;
        
        if (data.rarity === 'S') base = 30000;
        else if (data.rarity === 'A') base = 7500;
        else if (data.rarity === 'B') base = 3500;
        else if (data.rarity === 'C') base = 1000;
        else if (data.rarity === 'D') return 1000; // Heroã¯å›ºå®š1000
        
        let income = base * level * (data.incomeMult || 1.0);
        
        // ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ï¼ˆè‰²é•ã„ï¼‰ãƒœãƒ¼ãƒŠã‚¹ï¼šç”Ÿç”£ç‡5å€
        if (slot.dataset.isSpecial === "true") {
            income *= 5.0;
        }
        
        return income; 
    }

    function updateManaUI() {
        manaValDisplay.innerText = formatMana(totalMana);
        const buyButtons = document.querySelectorAll('.buy-button');
        buyButtons.forEach(btn => {
            if (btn.innerText !== 'å¥‘ç´„æ¸ˆã¿' && btn.innerText !== 'FREE HERO') {
                const price = parseInt(btn.dataset.price);
                btn.disabled = (totalMana < price);
            }
        });
        
        // ä¸Šä½ãƒ¬ãƒ™ãƒ«è§£æ”¾ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹ç„¡åŠ¹çŠ¶æ…‹ã®ã¿ã‚’æ›´æ–°ï¼ˆå†æç”»ã«ã‚ˆã‚‹ãƒãƒ©ã¤ãé˜²æ­¢ï¼‰
        const upgradeBtn = document.getElementById('upgrade-box-btn');
        if (upgradeBtn) {
            let upgradePrices = {1: 5000000, 2: 50000000, 3: 500000000};
            let nextPrice = upgradePrices[maxUnlockedBoxLevel];
            if (nextPrice !== undefined) {
                upgradeBtn.disabled = (totalMana < nextPrice);
            }
        }
    }

    function chargeMana() {
        const deckSlots = document.querySelectorAll('#deck-area .collected-item.opened');
        let income = 0;
        deckSlots.forEach(slot => {
            const perSec = calculateIncome(slot);
            income += perSec / 10; // 0.1ç§’ã”ã¨ã®åŠ ç®—
        });
        totalMana += income;
        updateManaUI();
        if(Math.random() < 0.005) saveData();
    }
    setInterval(chargeMana, 100);

    function showGetMessage(text) {
        messageOverlay.innerText = text;
        messageOverlay.style.opacity = '1';
        setTimeout(() => messageOverlay.style.opacity = '0', 2000);
    }

    function createSlot(idPrefix, index) {
        const slot = document.createElement('div');
        slot.className = 'collected-item';
        slot.id = `${idPrefix}-${index}`;
        slot.dataset.level = 1;

        slot.addEventListener('dragstart', (e) => {
            if (!slot.classList.contains('has-item')) { e.preventDefault(); return; }
            draggedElement = slot;
            slot.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });

        slot.addEventListener('dragend', () => {
            slot.classList.remove('dragging');
            draggedElement = null;
            saveData();
        });

        slot.addEventListener('mouseenter', (e) => {
            if (!slot.classList.contains('opened')) return;
            const imgPath = slot.querySelector('.item-img').src.split('/').pop();
            const charName = CHAR_DATA[imgPath]?.name || "ä¸æ˜";
            let rarity = CHAR_DATA[imgPath]?.rarity || "C";
            const income = calculateIncome(slot);
            const shinyText = slot.dataset.isSpecial === "true" ? "<br><span style='color:#fff; text-shadow:0 0 5px #fff;'>â˜…Shiny (x5 Mana)â˜…</span>" : "";
            tooltip.innerHTML = `<strong>Name: <span style="color:#00ffcc">${charName}</span></strong><br><strong>Rare: <span style="color:#f1c40f">${rarity}</span></strong>${shinyText}<br>Lv: ${rarity === 'D' ? '-' : slot.dataset.level}<br>Income: ${formatMana(income)}/sec`;
            tooltip.style.display = 'block';
        });

        slot.addEventListener('mousemove', (e) => {
            tooltip.style.left = (e.clientX + 15) + 'px';
            tooltip.style.top = (e.clientY + 15) + 'px';
        });

        slot.addEventListener('mouseleave', () => tooltip.style.display = 'none');
        slot.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; });
        slot.addEventListener('drop', (e) => {
            e.preventDefault();
            if (draggedElement && draggedElement !== slot) {
                const isTargetInCollection = slot.closest('#collection-area') !== null;
                const srcImg = draggedElement.querySelector('.item-img')?.src;
                const destImg = slot.querySelector('.item-img')?.src;
                
                // Heroã¯åˆæˆä¸å¯
                const isHero = srcImg && srcImg.includes('hero.png');

                // é€šå¸¸å€‹ä½“ã¨ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼å€‹ä½“ã¯åˆæˆä¸å¯ï¼ˆisSpecialãŒä¸€è‡´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
                const isSameType = draggedElement.dataset.isSpecial === slot.dataset.isSpecial;

                if (!isHero && isTargetInCollection && draggedElement.classList.contains('opened') && slot.classList.contains('opened') && srcImg === destImg && isSameType) {
                    combineItems(draggedElement, slot);
                } else {
                    swapSlots(draggedElement, slot);
                }
                saveData();
            }
        });
        return slot;
    }

    function initBase() {
        for (let i = 0; i < MAX_STORAGE; i++) collectionArea.appendChild(createSlot('slot', i));
        for (let i = 0; i < MAX_DECK; i++) deckArea.appendChild(createSlot('deck', i));
    }

    function combineItems(src, dest) {
        let lvSrc = parseInt(src.dataset.level);
        let lvDest = parseInt(dest.dataset.level);
        
        // ã‚ˆã‚Šãƒ¬ãƒ™ãƒ«ãŒé«˜ã„æ–¹ã‚’åŸºæº–ã«ã—ã¦+1ã™ã‚‹
        let baseLv = Math.max(lvSrc, lvDest);
        
        if (baseLv >= 999) return; 
        let newLv = baseLv + 1;
        
        dest.dataset.level = newLv;
        
        // åˆæˆæ™‚ã«ã©ã¡ã‚‰ã‹ãŒã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ãªã‚‰ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ã‚’å¼•ãç¶™ãï¼ˆç¾åœ¨ã®ä»•æ§˜ã§ã¯åŒã˜ã‚¿ã‚¤ãƒ—ã—ã‹åˆæˆã•ã‚Œãªã„ï¼‰
        if (src.dataset.isSpecial === "true" || dest.dataset.isSpecial === "true") {
            dest.dataset.isSpecial = "true";
            dest.classList.add('is-shiny');
        }

        // æœ€é«˜ãƒ¬ãƒ™ãƒ«ã®è¨˜éŒ²ã‚’æ›´æ–°
        const imgPath = dest.querySelector('.item-img').src.split('/').pop();
        if(!maxLevels[imgPath] || newLv > maxLevels[imgPath]) maxLevels[imgPath] = newLv;

        playSound(seCombine);
        dest.style.transform = 'scale(1.2) rotate(10deg)';
        setTimeout(() => dest.style.transform = 'rotate(360deg)', 200);
        updateLevelDisplay(dest);
        showGetMessage(`åˆæˆæˆåŠŸï¼ Lv.${newLv}`);
        clearSlot(src);
        saveData();
    }

    function updateLevelDisplay(slot) {
        const badge = slot.querySelector('.level-badge');
        if (badge) {
            const imgPath = slot.querySelector('.item-img')?.src || "";
            if (imgPath.includes('hero.png')) {
                badge.style.display = 'none';
                return;
            }
            const lv = parseInt(slot.dataset.level);
            badge.innerText = `Lv.${lv}`;
            badge.style.display = 'block';
        }
    }

    function clearSlot(slot) {
        slot.style.transition = 'none';
        slot.style.transform = 'none';
        slot.innerHTML = '';
        slot.className = 'collected-item';
        slot.draggable = false;
        slot.dataset.level = 1;
        slot.dataset.isSpecial = "false";
        slot.onclick = null;
        slot.offsetHeight; 
        slot.style.transition = 'all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
        currentItemCount--;
    }

    manaShrine.addEventListener('dragover', (e) => { e.preventDefault(); manaShrine.classList.add('drag-over'); });
    manaShrine.addEventListener('dragleave', () => { manaShrine.classList.remove('drag-over'); });
    manaShrine.addEventListener('drop', (e) => {
        e.preventDefault();
        manaShrine.classList.remove('drag-over');
        if (draggedElement) sellItem(draggedElement);
    });

    function sellItem(slot) {
        const imgPath = slot.querySelector('.item-img')?.src || "";
        let sellPrice = 0;
        
        if (!imgPath.includes('hero.png')) {
            const income = calculateIncome(slot);
            sellPrice = income * 10;
        }

        totalMana += sellPrice;
        playSound(seSell);
        clearSlot(slot);
        showGetMessage(`ãƒãƒŠã¸ã¨å¤‰æ›ï¼ +${formatMana(sellPrice)}ç²å¾—`);
        updateManaUI();
        saveData();
    }

    function swapSlots(src, dest) {
        src.style.transition = 'none';
        dest.style.transition = 'none';
        const tempHtml = src.innerHTML;
        const tempClass = src.className;
        const tempLv = src.dataset.level;
        const tempDraggable = src.draggable;
        const tempSpecial = src.dataset.isSpecial;
        src.innerHTML = dest.innerHTML;
        src.className = dest.className;
        src.dataset.level = dest.dataset.level;
        src.dataset.isSpecial = dest.dataset.isSpecial;
        src.draggable = dest.draggable;
        dest.innerHTML = tempHtml;
        dest.className = tempClass;
        dest.dataset.level = tempLv;
        dest.dataset.isSpecial = tempSpecial;
        dest.draggable = tempDraggable;
        src.classList.remove('dragging');
        dest.classList.remove('dragging');
        src.onclick = (src.classList.contains('has-item') && !src.classList.contains('opened')) ? () => openAction(src) : null;
        dest.onclick = (dest.classList.contains('has-item') && !dest.classList.contains('opened')) ? () => openAction(dest) : null;
        requestAnimationFrame(() => { src.style.transition = ''; dest.style.transition = ''; });
    }

    function initShop() {
        shopArea.innerHTML = ''; 
        for (let i = 0; i < 10; i++) { 
            const slot = document.createElement('div');
            slot.className = 'shop-slot';
            const box = document.createElement('img');
            const btn = document.createElement('button');
            btn.className = 'buy-button';

            let isHero = (i === 0);
            
            if (isHero) {
                box.src = 'hero.png';
                btn.innerText = "FREE HERO";
                btn.dataset.price = 0;
            } else {
                box.src = 'box.png';
                // ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸè²©å£²ä¾¡æ ¼
                let boxPrices = {1: 100000, 2: 1000000, 3: 10000000, 4: 100000000};
                let price = boxPrices[boxLevel];
                btn.dataset.price = price;
                btn.innerText = `${formatMana(price)} Mana`;
            }

            box.className = 'buy-box';

            // ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸåœ¨åº«çŠ¶æ³ãŒã‚ã‚Œã°å¾©å…ƒ
            if (shopInventory && shopInventory[i]) {
                btn.disabled = true;
                btn.innerText = 'å¥‘ç´„æ¸ˆã¿';
                box.classList.add('sold-out-img');
            }
            
            const purchaseAction = () => {
                if (btn.innerText === 'å¥‘ç´„æ¸ˆã¿') return;
                startBGM();
                let price = parseInt(btn.dataset.price);
                if (totalMana < price) { showGetMessage("ãƒãƒŠãŒè¶³ã‚Šã¾ã›ã‚“ï¼"); return; }

                const collectionSlots = Array.from(document.querySelectorAll('#collection-area .collected-item'));
                const targetSlot = collectionSlots.find(s => !s.classList.contains('has-item'));
                if (targetSlot) {
                    totalMana -= price;
                    playSound(seCash);
                    if (isHero) {
                        collectHeroToSlot(targetSlot);
                    } else {
                        collectBoxToSlot(targetSlot, false);
                        btn.disabled = true;
                        btn.innerText = 'å¥‘ç´„æ¸ˆã¿';
                        box.classList.add('sold-out-img');
                    }
                    currentItemCount++;
                    updateManaUI();
                    saveData();
                } else { showGetMessage("ã‚¹ãƒ­ãƒƒãƒˆã«ç©ºããŒã‚ã‚Šã¾ã›ã‚“ï¼"); }
            };
            box.onclick = purchaseAction;
            btn.onclick = purchaseAction;
            slot.appendChild(box);
            slot.appendChild(btn);
            shopArea.appendChild(slot);
        }
        if(window.isFirstLoad === false) { playSound(seShopRefresh); showGetMessage("ãƒŸã‚¹ãƒ†ãƒªãƒ¼ã‚­ãƒ¥ãƒ¼ãƒ–ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ"); }
        window.isFirstLoad = false;
    }

    function updateTimer() {
        refreshTimer.innerText = `( æ›´æ–°ã¾ã§: ${timeLeft}ç§’ )`;
        if (timeLeft <= 0) {
            timeLeft = REFRESH_INTERVAL;
            shopInventory = null; // åœ¨åº«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
            initShop();
        }
        timeLeft--;
        if(timeLeft % 5 === 0) saveData(); 
    }
    setInterval(updateTimer, 1000);

    function openAction(targetSlot) {
        if (targetSlot.classList.contains('has-item') && !targetSlot.classList.contains('opened')) {
            playSound(seBox);
            
            // ãƒœãƒƒã‚¯ã‚¹ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸç¢ºç‡è¨­å®š
            const roll = Math.random() * 100;
            let targetRarity = 'C';
            
            if (boxLevel === 1) {
                if (roll < 1) targetRarity = 'A';
                else if (roll < 20) targetRarity = 'B';
                else targetRarity = 'C';
            } else if (boxLevel === 2) {
                if (roll < 1) targetRarity = 'S';
                else if (roll < 20) targetRarity = 'A';
                else if (roll < 50) targetRarity = 'B';
                else targetRarity = 'C';
            } else if (boxLevel === 3) {
                if (roll < 5) targetRarity = 'S';
                else if (roll < 30) targetRarity = 'A';
                else if (roll < 60) targetRarity = 'B';
                else targetRarity = 'C';
            } else { // Level MAX
                if (roll < 30) targetRarity = 'S';      // 0ã€œ29.9... (30%)
                else if (roll < 70) targetRarity = 'A'; // 30ã€œ69.9... (40%)
                else if (roll < 90) targetRarity = 'B'; // 70ã€œ89.9... (20%)
                else targetRarity = 'C';                // 90ã€œ100 (10%)
            }

            const possibleChars = Object.keys(CHAR_DATA).filter(k => CHAR_DATA[k].rarity === targetRarity);
            const randomChar = possibleChars[Math.floor(Math.random() * possibleChars.length)];
            const data = CHAR_DATA[randomChar];
            
            if(!unlockedChars.includes(randomChar)) {
                unlockedChars.push(randomChar);
                showGetMessage(`æ–°ç¨®ã®ã‚­ãƒ¥ãƒ¼ãƒ–ã€Œ${data.name}ã€ã‚’ç™ºè¦‹ï¼`);
            }
            
            // 0.1%ã®ç¢ºç‡ã§ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼å€‹ä½“ï¼ˆè‰²é•ã„ï¼‰ã«
            if (Math.random() < 0.001) {
                targetSlot.dataset.isSpecial = "true";
                targetSlot.classList.add('is-shiny');
                // ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼å€‹ä½“ã¯Lv 1ã€œ100 ã®ãƒ©ãƒ³ãƒ€ãƒ ã§ç”Ÿæˆ
                const randomLv = Math.floor(Math.random() * 100) + 1;
                targetSlot.dataset.level = randomLv;
                
                // å›³é‘‘ç”¨ã®ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼ç™ºè¦‹è¨˜éŒ²
                if(!unlockedShinies.includes(randomChar)) {
                    unlockedShinies.push(randomChar);
                }
                
                showGetMessage(`â˜…ã‚·ãƒ£ã‚¤ãƒ‹ãƒ¼å€‹ä½“ï¼ã€Œ${data.name}ã€Lv.${randomLv}â˜…`);
            } else {
                targetSlot.dataset.level = 1;
            }

            // æœ€é«˜ãƒ¬ãƒ™ãƒ«ã®è¨˜éŒ²
            const currentLv = parseInt(targetSlot.dataset.level);
            if(!maxLevels[randomChar] || currentLv > maxLevels[randomChar]) maxLevels[randomChar] = currentLv;

            const currentImg = targetSlot.querySelector('.item-img');
            if(currentImg) currentImg.src = randomChar;
            targetSlot.classList.remove('rarity-S', 'rarity-A', 'rarity-B', 'rarity-C', 'rarity-D');
            targetSlot.classList.add(`rarity-${data.rarity}`, 'opened');
            targetSlot.style.transform = 'rotate(360deg)';
            updateLevelDisplay(targetSlot);
            targetSlot.onclick = null;
            saveData();
        }
    }

    function collectBoxToSlot(targetSlot, isSpecial = false) {
        targetSlot.classList.add('has-item');
        targetSlot.draggable = true; 
        targetSlot.dataset.level = 1;
        targetSlot.dataset.isSpecial = isSpecial;
        const img = document.createElement('img');
        img.src = 'box.png';
        img.className = 'item-img';
        img.style.display = 'block';
        const badge = document.createElement('div');
        badge.className = 'level-badge';
        targetSlot.appendChild(img);
        targetSlot.appendChild(badge);
        targetSlot.onclick = () => openAction(targetSlot);
    }

    function collectHeroToSlot(targetSlot) {
        targetSlot.classList.add('has-item', 'opened', 'rarity-D');
        targetSlot.draggable = true; 
        targetSlot.dataset.level = 1;
        targetSlot.dataset.isSpecial = false;
        const img = document.createElement('img');
        img.src = 'hero.png';
        img.className = 'item-img';
        img.style.display = 'block';
        const badge = document.createElement('div');
        badge.className = 'level-badge';
        targetSlot.appendChild(img);
        targetSlot.appendChild(badge);
        if(!unlockedChars.includes('hero.png')) unlockedChars.push('hero.png');
        updateLevelDisplay(targetSlot);
    }

    window.isFirstLoad = true;
    initBase();
    loadGameProgress(); 
    initShop();
    updateTimer();
    updateVolume();
</script>
</body>
</html>